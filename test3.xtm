(sys:load "libs/core/instruments.xtm")

(bind-func saw_synth_note_c
  (lambda (data:NoteInitData* nargs:i64 dargs:SAMPLE*)
    (let ((sawl (saw_c 0.))
          (sawr (saw_c 0.)))
      (lambda (time:i64 chan:i64 freq:SAMPLE amp:SAMPLE)
        (cond ((= chan 0)
               (sawl amp freq))
              ((= chan 1)
               (sawr amp freq))
              (else 0.0))))))

(bind-func saw_synth_fx 200000 ;; extra memory for the delay lines
(let ((delayl (delay_c 22050))
      (delayr (delay_c 22050)))
  (lambda (in:SAMPLE time:i64 chan:i64 dat:SAMPLE*)
    (cond ((= chan 0)
           (delayl in 0.3 0.2))
          ((= chan 1)
           (delayr in 0.3 0.2))
          (else 0.0)))))

(bind-instrument saw_synth saw_synth_note_c saw_synth_fx)
